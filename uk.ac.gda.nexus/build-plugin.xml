<project name="plugin-uk.ac.gda.nexus" basedir=".">

    <dirname property="GDA-plugin.basedir" file="${ant.file.${ant.project.name}}" />
    <pathconvert property="workspace.loc" setonempty="false">
        <regexpmapper from="(.*)_git/.+" to="\1"/>
        <path><pathelement location="${GDA-plugin.basedir}" /></path>
    </pathconvert>
    <pathconvert property="workspace.loc" setonempty="false">
        <regexpmapper from="(.*)/plugins/.+" to="\1"/>
        <path><pathelement location="${GDA-plugin.basedir}" /></path>
    </pathconvert>
    <property name="workspace.git.loc" value="${workspace.loc}_git" />
    <import file="${workspace.loc}/builder/build-common.xml" />

    <!-- ====================================================================
           Build
         ==================================================================== -->

    <!-- the jython scripting view should auto-complete class and method names in this plugin -->
    <property name="plugin.enable.jython_autocomplete" value="true" />

    <!-- ====================================================================
           Invoke the tests
         ==================================================================== -->

    <target name="junit-tests" depends="toolCheck, set-test-base">
        <loadfile property="redhat_release" srcFile="/etc/redhat-release" failonerror="false" />
        <property name="redhat_release" value="probably not 5" />
        <condition property="NexusExtractorTest_skip_if_RH5" value="**/NexusExtractorTest.java" else="FilenameThatDoesNotExist">
            <contains string="${redhat_release}" substring="Red Hat Enterprise Linux Client release 5." />
        </condition>
        <condition property="NexusReadinTest_skip_if_RH5" value="**/NexusReadinTest.java" else="FilenameThatDoesNotExist">
            <contains string="${redhat_release}" substring="Red Hat Enterprise Linux Client release 5." />
        </condition>
        <junit-call description="${ant.project.name} Java JUnit tests" maxmemory="1536m">
            <formatter type="xml" />
            <classpath>
                <pathelement location="${junitjar.loc}" />
                <pathelement location="${GDA-plugin.basedir}/bin" />
                <pathelement location="${GDA-plugin.basedir}/jars/*" />
                <pathelement location="${workspace.git.loc}/gda-common.git/uk.ac.gda.common/bin" />
                <path refid="libs.jars.path" />
                <pathelement location="${workspace.loc}/tp/plugins/*" />
            </classpath>
            <batchtest todir="@{report.dir}">
                <fileset dir="${GDA-plugin.basedir}/test">
                    <include name="**/*Test.java" />
                    <exclude name="${NexusExtractorTest_skip_if_RH5}" />  <!-- doesn't always work on RedHat 5 -->
                    <exclude name="${NexusReadinTest_skip_if_RH5}" />  <!-- doesn't always work on RedHat 5 -->
                </fileset>
            </batchtest>
        </junit-call>
    </target>

</project>
